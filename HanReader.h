#ifndef _HANREADER_h
#define _HANREADER_h

#if defined(ARDUINO) && ARDUINO >= 100
  #include "arduino.h"
#else
  #include "WProgram.h"
#endif


#include "DlmsReader.h"

class HanReader
{
public:
	const uint dataHeader = 8;
	bool compensateFor09HeaderBug = false;

	HanReader();
	void setup(HardwareSerial *hanPort);
	void setup(HardwareSerial *hanPort, Stream *debugPort);
	void setup(HardwareSerial *hanPort, unsigned long baudrate, SerialConfig config, Stream *debugPort);
	bool read();
	bool read(byte data);
	int getListSize();
	time_t getPackageTime();
	int getInt(int objectId);
	int getInt(int start, int size);
	String getString(int objectId);
	String getString(int start, int Length);
	time_t getTime(int objectId);
	void Clear();
 Stream          *debug;
 int parseBlock(int element_counter);
 long  readOut[16];
 long getLong(int position);
 String mqttName[15] = { "nop", "actpwr14", "actpwr23", "reactpwr12", "reactpwr34", "il1_1", "il3_3", "ul1", "ul2", "ul3", "cu_act_14", "cu_act_23", "cu_react_12", "cu_react_24"};

private:
	// Stream          *debug;
	HardwareSerial  *han;
	byte            buffer[512];
	int             bytesRead;
	DlmsReader      reader;
	int             listSize;
  // Debug
  int             array_index = 0;
  int             element_counter;

// List 1
/*  
  int rx_data[65] = {
0x00,0x0a,0x41,0x02,0x02,0x0f,0x00,0x16,0x1b,0xae,0x59,0x7e,0x7e,0xa0,0x2a,0x41,
0x08,0x83,0x13,0x04,0x13,0xe6,0xe7,0x00,0x0f,0x40,0x00,0x00,0x00,0x00,0x01,0x01,  // Last element is element counter...
0x02,0x03,0x09,0x06,0x01,0x00,0x01,0x07,0x00,0xff,0x06,0x00,0x00,0x0a,0x4a,0x02,
0x02,0x0f,0x00,0x16,0x1b,0x2c,0x2f,0x7e,0x7e,0xa0,0x2a,0x41,0x08,0x83,0x13,0x04
};
*/

//  List 2
/*
int rx_data[273] = {
0xe4,0x7e,0x7e,0xa1,0x0b,0x41,0x08,0x83,0x13,0xfa,0x7c,0xe6,0xe7,0x00,0x0f,0x40,
0x00,0x00,0x00,0x00,0x01,0x0c,0x02,0x02,0x09,0x06,0x01,0x01,0x00,0x02,0x81,0xff,
0x0a,0x0b,0x41,0x49,0x44,0x4f,0x4e,0x5f,0x56,0x30,0x30,0x30,0x31,0x02,0x02,0x09,
0x06,0x00,0x00,0x60,0x01,0x00,0xff,0x0a,0x10,0x37,0x33,0x35,0x39,0x39,0x39,0x32,
0x38,0x39,0x39,0x35,0x36,0x36,0x33,0x33,0x35,0x02,0x02,0x09,0x06,0x00,0x00,0x60,
0x01,0x07,0xff,0x0a,0x04,0x36,0x35,0x32,0x35,0x02,0x03,0x09,0x06,0x01,0x00,0x01,
0x07,0x00,0xff,0x06,0x00,0x00,0x0a,0x16,0x02,0x02,0x0f,0x00,0x16,0x1b,0x02,0x03,
0x09,0x06,0x01,0x00,0x02,0x07,0x00,0xff,0x06,0x00,0x00,0x00,0x00,0x02,0x02,0x0f,
0x00,0x16,0x1b,0x02,0x03,0x09,0x06,0x01,0x00,0x03,0x07,0x00,0xff,0x06,0x00,0x00,
0x00,0x00,0x02,0x02,0x0f,0x00,0x16,0x1d,0x02,0x03,0x09,0x06,0x01,0x00,0x04,0x07,
0x00,0xff,0x06,0x00,0x00,0x00,0x5e,0x02,0x02,0x0f,0x00,0x16,0x1d,0x02,0x03,0x09,
0x06,0x01,0x00,0x1f,0x07,0x00,0xff,0x10,0x00,0x6e,0x02,0x02,0x0f,0xff,0x16,0x21,
0x02,0x03,0x09,0x06,0x01,0x00,0x47,0x07,0x00,0xff,0x10,0x00,0x51,0x02,0x02,0x0f,
0xff,0x16,0x21,0x02,0x03,0x09,0x06,0x01,0x00,0x20,0x07,0x00,0xff,0x12,0x08,0x4a,
0x02,0x02,0x0f,0xff,0x16,0x23,0x02,0x03,0x09,0x06,0x01,0x00,0x34,0x07,0x00,0xff,
0x12,0x08,0x63,0x02,0x02,0x0f,0xff,0x16,0x23,0x02,0x03,0x09,0x06,0x01,0x00,0x48,
0x07,0x00,0xff,0x12,0x08,0x7c,0x02,0x02,0x0f,0xff,0x16,0x23,0x04,0xac,0x7e,0x7e,0x00
};
*/

// List 3

int rx_data[384] = {
0x01,0x02,0x03,0x7e,0x7e,0xa1,0x77,0x41,0x08,0x83,0x13,0x39,0x1e,0xe6,0xe7,0x00,
0x0f,0x40,0x00,0x00,0x00,0x00,0x01,0x11,0x02,0x02,0x09,0x06,0x01,0x01,0x00,0x02,
0x81,0xff,0x0a,0x0b,0x41,0x49,0x44,0x4f,0x4e,0x5f,0x56,0x30,0x30,0x30,0x31,0x02,
0x02,0x09,0x06,0x00,0x00,0x60,0x01,0x00,0xff,0x0a,0x10,0x37,0x33,0x35,0x39,0x39,
0x39,0x32,0x38,0x39,0x39,0x35,0x36,0x36,0x33,0x33,0x35,0x02,0x02,0x09,0x06,0x00,
0x00,0x60,0x01,0x07,0xff,0x0a,0x04,0x36,0x35,0x32,0x35,0x02,0x03,0x09,0x06,0x01,
0x00,0x01,0x07,0x00,0xff,0x06,0x00,0x00,0x12,0x04,0x02,0x02,0x0f,0x00,0x16,0x1b,
0x02,0x03,0x09,0x06,0x01,0x00,0x02,0x07,0x00,0xff,0x06,0x00,0x00,0x00,0x00,0x02,
0x02,0x0f,0x00,0x16,0x1b,0x02,0x03,0x09,0x06,0x01,0x00,0x03,0x07,0x00,0xff,0x06,
0x00,0x00,0x00,0x00,0x02,0x02,0x0f,0x00,0x16,0x1d,0x02,0x03,0x09,0x06,0x01,0x00,
0x04,0x07,0x00,0xff,0x06,0x00,0x00,0x00,0x55,0x02,0x02,0x0f,0x00,0x16,0x1d,0x02,
0x03,0x09,0x06,0x01,0x00,0x1f,0x07,0x00,0xff,0x10,0x00,0xbf,0x02,0x02,0x0f,0xff,
0x16,0x21,0x02,0x03,0x09,0x06,0x01,0x00,0x47,0x07,0x00,0xff,0x10,0x00,0x6b,0x02,
0x02,0x0f,0xff,0x16,0x21,0x02,0x03,0x09,0x06,0x01,0x00,0x20,0x07,0x00,0xff,0x12,
0x08,0x1e,0x02,0x02,0x0f,0xff,0x16,0x23,0x02,0x03,0x09,0x06,0x01,0x00,0x34,0x07,
0x00,0xff,0x12,0x08,0x35,0x02,0x02,0x0f,0xff,0x16,0x23,0x02,0x03,0x09,0x06,0x01,
0x00,0x48,0x07,0x00,0xff,0x12,0x08,0x82,0x02,0x02,0x0f,0xff,0x16,0x23,0x02,0x02,
0x09,0x06,0x00,0x00,0x01,0x00,0x00,0xff,0x09,0x0c,0x07,0xe3,0x02,0x07,0x04,0x16,
0x00,0x00,0xff,0x00,0x00,0x00,0x02,0x03,0x09,0x06,0x01,0x00,0x01,0x08,0x00,0xff,
0x06,0x00,0x2a,0x94,0x5c,0x02,0x02,0x0f,0x01,0x16,0x1e,0x02,0x03,0x09,0x06,0x01,
0x00,0x02,0x08,0x00,0xff,0x06,0x00,0x00,0x00,0x00,0x02,0x02,0x0f,0x01,0x16,0x1e,
0x02,0x03,0x09,0x06,0x01,0x00,0x03,0x08,0x00,0xff,0x06,0x00,0x00,0x0a,0x95,0x02,
0x02,0x0f,0x01,0x16,0x20,0x02,0x03,0x09,0x06,0x01,0x00,0x04,0x08,0x00,0xff,0x06,
0x00,0x01,0xb1,0x2a,0x02,0x02,0x0f,0x01,0x16,0x20,0x57,0x0b,0x7e,0x7e,0xa1,0x12
};


	int findValuePosition(int dataPosition, byte *buffer, int start, int length);

	time_t getTime(int dataPosition, byte *buffer, int start, int length);
	time_t getTime(byte *buffer, int start, int length);
	int getInt(int dataPosition, byte *buffer, int start, int length);
	String getString(int dataPosition, byte *buffer, int start, int length);

	time_t toUnixTime(int year, int month, int day, int hour, int minute, int second);

	void debugPrint(byte *buffer, int start, int length);
 int getPosition(int hash);
};


#endif
